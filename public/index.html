<!doctype html>
<meta charset="utf-8">
<title>EPUB ➜ PDF Converter</title>
<style>
 body{font-family:system-ui;padding:2rem;max-width:30rem;margin:auto}
 label{display:block;margin:1rem 0}
 button{padding:.5rem 1rem;border:0;border-radius:.3rem;cursor:pointer}
</style>

<h1>EPUB ➜ PDF Converter</h1>
<form id="form">
  <label>
    Select EPUB:
    <input type="file" name="epub" accept=".epub" required>
  </label>

  <label>
    Page size:
    <select name="pageSize">
      <option value="a5" selected>A5 (Daylight default)</option>
      <option value="a4">A4</option>
      <option value="letter">Letter</option>
    </select>
  </label>

  <label>
    Extra Margin (pt):
    <input type="number" name="margin" value="0" min="0" max="36">
  </label>

  <label for="baseFontSize">
    Base Font Size (pt):
    <input type="number" id="baseFontSize" name="baseFontSize" min="6" max="24" value="10">
  </label>

  <button>Convert</button>
  <button type="button" id="previewButton" style="margin-left: 0.5rem;">Preview</button>
</form>

<div id="previewArea" style="margin-top: 2rem; display: none;">
  <h3>Preview:</h3>
  <iframe id="previewPdf" style="width: 100%; height: 600px; border: 1px solid #ccc;"></iframe>
</div>

<script>
document.getElementById("form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const btn = e.target.querySelector("button");
  btn.disabled = true; btn.textContent = "Converting…";

  const r = await fetch("/convert", { method:"POST", body:fd });
  if(r.ok){
    const blob = await r.blob();
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = fd.get("epub").name.replace(/\.epub$/i,".pdf");
    a.click();
  } else if(r.status === 429){
    alert("Whoa there! Rate limit hit – try again later.");
  } else {
    alert("Conversion failed");
  }
  btn.disabled = false; btn.textContent = "Convert";
});

document.getElementById("previewButton").addEventListener("click", async (e) => {
  const form = document.getElementById("form");
  const fd = new FormData(form);
  const btn = e.target; // The preview button itself
  const previewArea = document.getElementById("previewArea");
  const previewPdfFrame = document.getElementById("previewPdf");

  // Check if a file is selected, which is the most crucial part for FormData
  const epubInput = form.querySelector("input[name='epub']");
  if (!epubInput.files || epubInput.files.length === 0) {
    alert("Please select an EPUB file first.");
    epubInput.focus(); // Focus the file input
    // You might want to trigger HTML5 validation UI if possible, 
    // but a simple alert is often more straightforward for file inputs.
    return;
  }
  // Optionally, you can check other fields if they have client-side validation needs
  // not covered by `required` or type constraints handled by FormData construction.

  btn.disabled = true; btn.textContent = "Generating Preview…";
  previewPdfFrame.src = "about:blank"; // Clear previous preview
  previewArea.style.display = "none";

  try {
    const r = await fetch("/preview", { method:"POST", body:fd });
    if(r.ok){
      const blob = await r.blob();
      if (blob.type === "application/pdf") {
        previewPdfFrame.src = URL.createObjectURL(blob);
        previewArea.style.display = "block";
      } else {
        const errorText = await blob.text(); // Or r.text() if blob isn't created
        alert(`Preview failed: Received unexpected content type: ${blob.type}. Server said: ${errorText}`);
      }
    } else {
      const errorText = await r.text();
      alert(`Preview failed: ${r.status} - ${errorText || 'Server error'}`);
    }
  } catch (error) {
    console.error("Error fetching preview:", error);
    alert("Preview request failed. Check console for details.");
  } finally {
    btn.disabled = false; btn.textContent = "Preview";
  }
});
</script> 